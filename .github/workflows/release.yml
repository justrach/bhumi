name: ğŸš€ Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.4.0)'
        required: true
      test_pypi:
        description: 'Upload to Test PyPI instead of PyPI'
        type: boolean
        default: false

jobs:
  # Build wheels for Linux, macOS, and Windows
  build-wheels:
    name: ğŸ—ï¸ Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64
          - os: windows-latest
            target: x64
          - os: macos-13  # Intel
            target: x86_64
          - os: macos-14  # Apple Silicon
            target: aarch64

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ—ï¸ Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out wheelhouse --strip
          sccache: 'true'
          manylinux: '2014'
          before-script-linux: |
            # Install OpenSSL development libraries in the manylinux container
            yum update -y
            yum install -y openssl-devel pkgconfig

      - name: ğŸ“¤ Upload wheels as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  # Build source distribution
  build-sdist:
    name: ğŸ“¦ Build source distribution
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ”§ Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin build

      - name: ğŸ“¦ Build source distribution
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: ğŸ“¤ Upload sdist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  # Test installation from wheels (skipped for faster releases)
  test-wheels:
    name: ğŸ§ª Test wheel installation
    needs: [build-wheels]
    runs-on: ${{ matrix.os }}
    if: false  # Skip integration tests for faster releases
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
      - name: ğŸ“¥ Download wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ” Install and test wheel
        run: |
          python -m pip install --upgrade pip
          # Find and install the appropriate wheel for this Python version
          python -c "
          import os, sys
          version = f'{sys.version_info.major}{sys.version_info.minor}'
          wheels = [f for f in os.listdir('wheelhouse') if f.endswith('.whl') and f'cp{version}' in f]
          if wheels:
              os.system(f'pip install wheelhouse/{wheels[0]}')
              print(f'Installed wheel: {wheels[0]}')
          else:
              print(f'No wheel found for Python {sys.version_info.major}.{sys.version_info.minor}')
              exit(1)
          "
          
          # Test the installation
          python -c "
          try:
              import bhumi
              print('âœ… Bhumi imported successfully')
              from bhumi.utils import print_performance_status
              print_performance_status()
              print('âœ… All tests passed!')
          except Exception as e:
              print(f'âŒ Test failed: {e}')
              exit(1)
          "

  # Create GitHub release
  create-release:
    name: ğŸ“‹ Create GitHub Release
    needs: [build-wheels, build-sdist]  # Removed test-wheels dependency
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: ğŸ“ Organize artifacts
        run: |
          mkdir -p final-dist
          find dist -name "*.whl" -exec cp {} final-dist/ \;
          find dist -name "*.tar.gz" -exec cp {} final-dist/ \;
          ls -la final-dist/

      - name: ğŸ“‹ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: final-dist/*
          generate_release_notes: true
          body: |
            ## ğŸ‰ Bhumi Release ${{ github.ref_name }}
            
            Pre-compiled wheels are now available for:
            - ğŸ Python 3.8, 3.9, 3.10, 3.11, 3.12
            - ğŸ–¥ï¸ Linux (x86_64)
            - ğŸ macOS (Intel & Apple Silicon)
            - ğŸªŸ Windows (x86_64)
            
            ### Installation
            ```bash
            pip install bhumi==${{ github.ref_name }}
            ```
            
            **No Rust compiler required!** ğŸŠ
            
            See the full changelog and documentation for more details.

  # Publish to PyPI
  publish-pypi:
    name: ğŸš€ Publish to PyPI
    needs: [build-wheels, build-sdist]  # Removed test-wheels dependency
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.version

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: ğŸ“ Organize artifacts for PyPI
        run: |
          mkdir -p pypi-dist
          find dist -name "*.whl" -exec cp {} pypi-dist/ \;
          find dist -name "*.tar.gz" -exec cp {} pypi-dist/ \;
          ls -la pypi-dist/

      - name: ğŸš€ Publish to Test PyPI
        if: github.event.inputs.test_pypi == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/
          packages-dir: pypi-dist/

      - name: ğŸš€ Publish to PyPI
        if: startsWith(github.ref, 'refs/tags/') && github.event.inputs.test_pypi != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: pypi-dist/

  # Notify on completion
  notify:
    name: ğŸ“¢ Notify Release Complete
    needs: [create-release, publish-pypi]
    runs-on: ubuntu-latest
    if: always() && (startsWith(github.ref, 'refs/tags/') || github.event.inputs.version)

    steps:
      - name: ğŸ“¢ Success Notification
        if: needs.create-release.result == 'success' && needs.publish-pypi.result == 'success'
        run: |
          echo "ğŸ‰ Release completed successfully!"
          echo "âœ… GitHub release created"
          echo "âœ… Published to PyPI"
          echo "Users can now install with: pip install bhumi"

      - name: âš ï¸ Failure Notification
        if: needs.create-release.result == 'failure' || needs.publish-pypi.result == 'failure'
        run: |
          echo "âŒ Release failed!"
          echo "Check the logs above for details"
          exit 1
