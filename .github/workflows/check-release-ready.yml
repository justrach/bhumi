name: âœ… Check Release Readiness

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  check-build:
    name: ğŸ” Test Build Process
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.11']

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin

      - name: ğŸ—ï¸ Test Build
        uses: PyO3/maturin-action@v1
        with:
          args: --release --out dist
          
      - name: âœ… Build Success
        run: echo "âœ… Build successful on ${{ matrix.os }} with Python ${{ matrix.python-version }}"

      - name: ğŸ§ª Test Installation
        run: |
          # List what's in dist folder for debugging
          echo "Contents of dist folder:"
          ls -la dist/
          
          # Install directly from the wheel file, not by package name
          WHEEL_FILE=$(ls dist/*.whl | head -1)
          echo "Installing wheel: $WHEEL_FILE"
          pip install "$WHEEL_FILE"
          python -c "import bhumi; print('âœ… Import successful')"

  check-version:
    name: ğŸ·ï¸ Check Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ” Check Version Format
        run: |
          python -c "
          import re
          with open('pyproject.toml') as f:
              content = f.read()
          
          version_match = re.search(r'version = \"([^\"]+)\"', content)
          if not version_match:
              print('âŒ No version found in pyproject.toml')
              exit(1)
          
          version = version_match.group(1)
          print(f'ğŸ“¦ Current version: {version}')
          
          # Check semantic versioning format
          if not re.match(r'^\d+\.\d+\.\d+(?:-[a-zA-Z0-9]+)?$', version):
              print(f'âŒ Invalid version format: {version}')
              print('Use semantic versioning (e.g., 1.0.0, 1.0.0-beta1)')
              exit(1)
          
          print('âœ… Version format is valid')
          "

  check-dependencies:
    name: ğŸ“‹ Check Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Validate pyproject.toml
        run: |
          python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          
          print('âœ… pyproject.toml is valid TOML')
          print(f'ğŸ“¦ Package: {data[\"project\"][\"name\"]}')
          print(f'ğŸ·ï¸ Version: {data[\"project\"][\"version\"]}')
          print(f'ğŸ“ Description: {data[\"project\"][\"description\"]}')
          print(f'ğŸ‘¤ Authors: {data[\"project\"][\"authors\"]}')
          print(f'ğŸ Python requirement: {data[\"project\"][\"requires-python\"]}')
          print(f'ğŸ“¦ Dependencies: {data[\"project\"][\"dependencies\"]}')
          "

      - name: ğŸ” Check Required Files
        run: |
          echo "Checking required files for release..."
          
          files_to_check=(
            "README.md"
            "LICENSE" 
            "pyproject.toml"
            "Cargo.toml"
            "src/lib.rs"
          )
          
          for file in "${files_to_check[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file is missing"
              exit 1
            fi
          done
          
          echo "âœ… All required files present"
